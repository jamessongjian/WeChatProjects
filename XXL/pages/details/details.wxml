<wxs module="utils">
  function toInt(num) {
    if (typeof num !== 'number') {
      num = parseFloat(num) || 0;
    }
    return Math.floor(num);
  }
  module.exports.toInt = toInt;
</wxs>

<view class="details-container">
  <!-- åŠ è½½æç¤º -->
  <view class="loading-container" wx:if="{{loading}}">
    <view class="loading"></view>
    <text>åŠ è½½ä¸­...</text>
  </view>

  <!-- è¯¦æƒ…å†…å®¹ -->
  <block wx:if="{{!loading && item}}">
    <!-- å¤´éƒ¨åŒºåŸŸï¼šå›¾ç‰‡ã€åç§°ç­‰ -->
    <view class="header">
      <image class="cover-image" src="{{item.image}}" mode="aspectFill"></image>
      <view class="header-overlay">
        <view class="item-name">{{item.name}}</view>
        <view class="item-location">{{item.location}}</view>
        
        <!-- ç±»å‹å¾½ç«  -->
        <view class="item-type-badge {{item.type}}">
          <text wx:if="{{item.type === 'attraction'}}">æ¸¸ä¹è®¾æ–½</text>
          <text wx:elif="{{item.type === 'performance'}}">è¡¨æ¼”</text>
          <text wx:elif="{{item.type === 'restaurant'}}">é¤å…</text>
          <text wx:elif="{{item.type === 'shop'}}">å•†åº—</text>
          <text wx:elif="{{item.type === 'restroom'}}">æ´—æ‰‹é—´</text>
          <text wx:elif="{{item.type === 'charger'}}">å……ç”µå®</text>
          <text wx:else>{{item.type}}</text>
        </view>
      </view>
      
      <!-- æ“ä½œæŒ‰é’® -->
      <view class="action-buttons">
        <view class="action-button" bindtap="handleFavorite">
          <view class="icon {{isFavorite ? 'icon-favorite-active' : 'icon-favorite'}}"></view>
          <text class="action-text">{{isFavorite ? 'å·²è—' : 'æ”¶è—'}}</text>
        </view>
        <view class="action-button" bindtap="handleNavigation">
          <view class="icon icon-navigation"></view>
          <text class="action-text">å¯¼èˆª</text>
        </view>
        <view class="action-button" bindtap="handleShare">
          <view class="icon icon-share"></view>
          <text class="action-text">åˆ†äº«</text>
        </view>
      </view>
    </view>

    <!-- æ»šåŠ¨é€šçŸ¥æ  -->
    <view class="notification-bar" wx:if="{{item.notification}}">
      <view class="notification-icon">ğŸ“¢</view>
      <view class="notification-content">
        <view class="notification-scroll-container">
          <view class="notification-scroll-text {{item.notification.length <= 20 ? 'no-scroll' : ''}}">{{item.notification}}</view>
        </view>
      </view>
    </view>

    <!-- ä¸»è¦ä¿¡æ¯åŒºåŸŸ -->
    <view class="main-info">
      <!-- é¡¹ç›®æ ‡ç­¾ -->
      <view class="tags-container" wx:if="{{item.flags && item.flags.length > 0}}">
        <block wx:for="{{item.flags}}" wx:key="*this" wx:for-item="flag">
          <view class="tag">{{flag}}</view>
        </block>
      </view>

      <!-- ç­‰å¾…æ—¶é—´ (æ¸¸ä¹è®¾æ–½) -->
      <view class="wait-time-container" wx:if="{{item.type === 'attraction'}}">
        <view class="wait-time-box {{item.colorTheme}}">
          <view class="wait-time">{{item.waitTime}}</view>
          <view class="wait-unit">{{item.waitUnit}}</view>
        </view>
        <view class="open-time">å¼€æ”¾æ—¶é—´: {{item.openTime}}</view>
      </view>

      <!-- æ¼”å‡ºæ—¶é—´ (è¡¨æ¼”) -->
      <view class="show-times-container" wx:elif="{{item.type === 'performance'}}">
        <view class="section-title">ä»Šæ—¥æ¼”å‡ºåœºæ¬¡</view>
        <view class="show-times-list" wx:if="{{item.formattedShowTimes && item.formattedShowTimes.length > 0}}">
          <block wx:for="{{item.formattedShowTimes}}" wx:key="time">
            <view class="show-time-item {{item.isFull ? 'full' : (item.isPast ? 'past' : '')}}" 
                  bindtap="showReminderPanel" 
                  data-show-time="{{item.time}}" 
                  data-show-index="{{index}}" 
                  wx:if="{{!item.isPast}}">
              <text class="time">{{item.time}}</text>
              <text class="status {{item.colorTheme}}">{{item.status}}</text>
              <view class="alarm-icon">â°</view>
            </view>
            <view class="show-time-item {{item.isFull ? 'full' : (item.isPast ? 'past' : '')}}" wx:else>
              <text class="time">{{item.time}}</text>
              <text class="status {{item.colorTheme}}">{{item.status}}</text>
            </view>
          </block>
        </view>
        <view class="no-shows" wx:else>ä»Šæ—¥æš‚æ— åœºæ¬¡</view>
        <view class="duration" wx:if="{{item.duration}}">æ¼”å‡ºæ—¶é•¿: {{item.duration}}</view>
        <view class="open-time" wx:if="{{item.openTime}}">å¼€æ”¾æ—¶é—´: {{item.openTime}}</view>
      </view>

      <!-- é¤å…è¥ä¸šçŠ¶æ€ (é¤å…) -->
      <view class="wait-time-container" wx:elif="{{item.type === 'restaurant'}}">
        <view class="wait-time-box {{item.colorTheme}}">
          <view class="wait-time">{{item.waitTime}}</view>
          <view class="wait-unit">{{item.waitUnit}}</view>
        </view>
        <view class="open-time">è¥ä¸šæ—¶é—´: {{item.openTime}}</view>
      </view>

      <!-- é¤å…è¯¦ç»†ä¿¡æ¯ -->
      <view class="restaurant-info" wx:if="{{item.type === 'restaurant'}}">
        <view class="info-row" wx:if="{{item.cuisine}}">
          <view class="info-label">èœç³»:</view>
          <view class="info-value">{{item.cuisine}}</view>
        </view>
        <view class="info-row" wx:if="{{item.price}}">
          <view class="info-label">ä»·æ ¼:</view>
          <view class="info-value">{{item.price}}</view>
        </view>
        <view class="info-row" wx:if="{{item.additionalInfo}}">
          <view class="info-label">ä¼˜æƒ :</view>
          <view class="info-value">{{item.additionalInfo}}</view>
        </view>
      </view>

      <!-- é¤å…ä»‹ç» - å½“ç±»å‹ä¸ºé¤å…æ—¶ -->
      <view class="description-container" wx:if="{{item.type === 'restaurant'}}">
        <view class="section-title">é¤å…ä»‹ç»</view>
        <view class="summary" wx:if="{{item.summary}}">{{item.summary}}</view>
        <view class="detail" wx:if="{{item.detail}}">{{item.detail}}</view>
        <view class="detail" wx:if="{{item.description}}">{{item.description}}</view>
        <view class="no-description" wx:if="{{!item.summary && !item.detail && !item.description}}">æš‚æ— é¤å…ä»‹ç»</view>
      </view>

      <!-- é¤å…èœå“å±•ç¤º -->
      <view class="restaurant-dishes" wx:if="{{item.type === 'restaurant' && item.products && item.products.length > 0}}">
        <view class="section-title">ç‰¹è‰²èœå“</view>
        <view class="dishes-container">
          <block wx:for="{{item.products}}" wx:key="title" wx:for-item="dish">
            <view class="dish-item">
              <image class="dish-image" src="{{dish.cover_image}}" mode="aspectFill"></image>
              <view class="dish-name">{{dish.title}}</view>
            </view>
          </block>
        </view>
      </view>

      <!-- é¡¹ç›®æè¿° - å½“ç±»å‹ä¸æ˜¯é¤å…æ—¶ -->
      <view class="description-container" wx:if="{{item.type !== 'restaurant'}}">
        <view class="section-title" wx:if="{{item.type === 'restroom'}}">æ´—æ‰‹é—´ä»‹ç»</view>
        <view class="section-title" wx:elif="{{item.type === 'charger'}}">å……ç”µå®ä»‹ç»</view>
        <view class="section-title" wx:else>é¡¹ç›®ä»‹ç»</view>
        <view class="summary" wx:if="{{item.summary}}">{{item.summary}}</view>
        <view class="detail" wx:if="{{item.detail}}">{{item.detail}}</view>
        <view class="detail" wx:if="{{item.description && !item.summary}}">{{item.description}}</view>
        <view class="no-description" wx:if="{{!item.summary && !item.detail && !item.description}}">æš‚æ— é¡¹ç›®ä»‹ç»</view>
      </view>

      <!-- æ’é˜Ÿæ—¶é—´æ¨¡å— (ä»…æ¸¸ä¹è®¾æ–½) -->
      <view class="wait-time-history-container" wx:if="{{item.type === 'attraction' && (parkId === 'universal' || parkId === 'disney')}}">
        <view class="section-title">æ’é˜Ÿæ—¶é—´</view>
        
        <!-- åŠ è½½ä¸­æç¤º -->
        <view class="wait-time-loading" wx:if="{{!hasWaitTimeData && !waitTimeError}}">
          <view class="loading-icon"></view>
          <text class="loading-text">æ’é˜Ÿæ•°æ®åŠ è½½ä¸­...</text>
        </view>
        
        <!-- é”™è¯¯æç¤º -->
        <view class="wait-time-error" wx:if="{{waitTimeError}}">
          <view class="error-icon"></view>
          <text class="error-text">{{waitTimeErrorMsg}}</text>
        </view>
        
        <scroll-view scroll-x="true" class="chart-scroll-view" enhanced="true" show-scrollbar="false" scroll-into-view="hour-{{waitTimeData.current_hour}}" wx:if="{{hasWaitTimeData}}">
          <view class="chart-container">
            <block wx:if="{{waitTimeData}}">
              <view wx:for="{{waitTimeData.historical_wait_times}}" wx:key="index" wx:for-index="hour" class="hour-column {{hour === waitTimeData.current_hour ? 'current-hour' : ''}}" id="hour-{{hour}}">
                <!-- å°æ—¶æ ‡ç­¾ -->
                <view class="hour-label">
                  {{hour}}
                  <text wx:if="{{hour === waitTimeData.current_hour}}" class="current-hour-tag">å½“å‰</text>
                </view>
                
                <view class="bars-container">
                  <!-- å†å²æ’é˜Ÿæ—¶é—´æŸ± -->
                  <view class="bar history-bar" style="height: {{item * 200 / maxWaitTime < 20 ? 20 : item * 200 / maxWaitTime}}rpx;">
                  </view>
                  
                  <!-- ä»Šæ—¥æ’é˜Ÿæ—¶é—´æŸ± -->
                  <view wx:if="{{waitTimeData.today_hourly_wait_times[hour] && waitTimeData.today_hourly_wait_times[hour].wait_time >= 0}}" 
                       class="bar today-bar" style="height: {{waitTimeData.today_hourly_wait_times[hour].wait_time * 200 / maxWaitTime < 20 ? 20 : waitTimeData.today_hourly_wait_times[hour].wait_time * 200 / maxWaitTime}}rpx;">
                  </view>
                </view>
                
                <!-- æ•°å€¼æ ‡ç­¾ -->
                <view class="wait-time-values">
                  <view class="wait-time-value history">
                    <text>å†å²: </text><text>{{utils.toInt(item)}}</text>
                  </view>
                  <view class="wait-time-value today" wx:if="{{waitTimeData.today_hourly_wait_times[hour] && waitTimeData.today_hourly_wait_times[hour].wait_time >= 0}}">
                    <text>ä»Šæ—¥: </text><text>{{utils.toInt(waitTimeData.today_hourly_wait_times[hour].wait_time)}}</text>
                  </view>
                </view>
              </view>
            </block>
          </view>
        </scroll-view>
        
        <!-- å›¾ä¾‹ -->
        <view class="chart-legend" wx:if="{{hasWaitTimeData}}">
          <view class="legend-item">
            <view class="legend-color today-color"></view>
            <text>ä»Šæ—¥å®æ—¶</text>
          </view>
          <view class="legend-item">
            <view class="legend-color history-color"></view>
            <text>å†å²å¹³å‡</text>
          </view>
        </view>
      </view>

      <!-- æ¨èæŸ¥è¯¢ -->
      <view class="suggested-queries" wx:if="{{item.suggestedQueries && item.suggestedQueries.length > 0}}">
        <view class="section-title">ç›¸å…³é—®é¢˜</view>
        <view class="queries-list">
          <block wx:for="{{item.suggestedQueries}}" wx:key="*this" wx:for-item="query">
            <view class="query-item" bindtap="handleQueryClick" data-query="{{query}}">
              {{query}}
            </view>
          </block>
        </view>
      </view>
    </view>
  </block>

  <!-- é”™è¯¯æç¤º -->
  <view class="error-container" wx:if="{{!loading && !item}}">
    <view class="error-icon"></view>
    <text>æ— æ³•åŠ è½½é¡¹ç›®ä¿¡æ¯</text>
    <button class="back-button" bindtap="navigateBack">è¿”å›</button>
  </view>

  <!-- æé†’é¢æ¿ -->
  <view class="reminder-overlay" wx:if="{{showReminderPanel}}" bindtap="hideReminderPanel">
    <view class="reminder-panel" catchtap="noop">
      <view class="reminder-header">
        <text class="reminder-title">è®¾ç½®æ¼”å‡ºæé†’</text>
        <text class="close-btn" bindtap="hideReminderPanel">Ã—</text>
      </view>
      
      <view class="reminder-content">
        <view class="reminder-info">
          <text class="show-name">{{item.name}}</text>
          <text class="show-time">åœºæ¬¡æ—¶é—´ï¼š{{selectedShowTime}}</text>
        </view>
        
        <view class="reminder-form">
          <view class="form-item">
            <text class="form-label">æé†’æ—¥æœŸ</text>
            <picker mode="date" value="{{reminderDate}}" bindchange="onDateChange" start="{{todayDate}}" end="{{maxDate}}">
              <view class="form-input">{{reminderDate}}</view>
            </picker>
          </view>
          
          <view class="form-item">
            <text class="form-label">æå‰æ—¶é—´</text>
            <picker range="{{advanceTimeOptions}}" range-key="text" value="{{advanceTimeIndex}}" bindchange="onAdvanceTimeChange">
              <view class="form-input">{{advanceTimeOptions[advanceTimeIndex].text}}</view>
            </picker>
          </view>
        </view>
        
        <view class="reminder-buttons">
          <button class="cancel-btn" bindtap="hideReminderPanel">å–æ¶ˆ</button>
          <button class="confirm-btn" bindtap="confirmReminder">ç¡®å®š</button>
        </view>
      </view>
    </view>
  </view>
</view> 