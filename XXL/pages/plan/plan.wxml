<view class="plan-container">
  <!-- æ¸¸ä¹åœºé€‰æ‹©å™¨ - ä¸é¦–é¡µä¿æŒä¸€è‡´ -->
  <view class="park-selector">
    <picker bindchange="onParkChange" value="{{currentParkIndex}}" range="{{parks}}" range-key="name">
      <view class="park-picker">
        <text class="current-park">{{currentPark}}</text>
        <text class="fa fa-chevron-down picker-arrow"></text>
      </view>
    </picker>
  </view>

  <!-- æ”¶è—åŒºåŸŸ -->
  <view class="favorites-section">
    <view class="section-title">æˆ‘çš„æ”¶è—</view>
    
    <!-- åŠ è½½çŠ¶æ€ -->
    <view class="loading-favorites" wx:if="{{isLoadingFavorites}}">
      <view class="loading-icon"></view>
    </view>
    
    <!-- æ”¶è—åˆ—è¡¨ -->
    <view class="favorites-grid" wx:elif="{{favorites.length > 0}}">
      <view class="favorite-item" wx:for="{{favorites}}" wx:key="id">
        <view class="favorite-content" bindtap="onFavoriteItemTap" data-id="{{item.id}}">
          <image class="favorite-image" src="{{item.image || '/images/placeholder.png'}}" mode="aspectFill" binderror="onImageError" data-index="{{index}}"></image>
          <view class="favorite-name">{{item.name}}</view>
        </view>
        <view class="delete-btn" catchtap="onDeleteFavorite" data-id="{{item.id}}">
          <text class="close-icon">Ã—</text>
        </view>
      </view>
    </view>
    
    <!-- ç©ºçŠ¶æ€ -->
    <view class="empty-favorites" wx:else>
      <view class="empty-text">æš‚æ— æ”¶è—é¡¹ç›®</view>
    </view>
  </view>

  <!-- è¾“å…¥åŒºåŸŸä¸æ¨èè§„åˆ’åˆå¹¶ -->
  <view class="input-section">
    <view class="input-container">
      <input class="plan-input" placeholder="è¯·è¾“å…¥è§„åˆ’å†…å®¹" bindinput="onInputChange" value="{{inputValue}}"/>
      <button class="plan-button" bindtap="onStartPlan">è§„åˆ’</button>
    </view>
    
    <!-- æŸ¥è¯¢è¯åˆ—è¡¨ -->
    <view class="query-section">
      <view class="query-title">
        <text class="query-title-text">æ¨èè§„åˆ’</text>
        <text class="query-subtitle">ç‚¹å‡»å¿«é€Ÿå¼€å§‹</text>
      </view>
      <view class="query-list">
        <view class="query-item" wx:for="{{queryList}}" wx:key="*this" bindtap="onQueryTap" data-query="{{item}}">
          <text class="query-icon">ğŸ”</text>
          <text class="query-text">{{item}}</text>
        </view>
      </view>
    </view>
  </view>

  <!-- è§„åˆ’åŠ è½½çŠ¶æ€æç¤º -->
  <view class="planning-loading-container" wx:if="{{isPlanningLoading}}">
    <view class="planning-loading-box">
      <view class="planning-loading-icon"></view>
      <view class="planning-loading-text">
        <text>æ­£åœ¨è®¡ç®—è§„åˆ’è¡Œç¨‹</text>
        <text class="loading-dots">{{planningLoadingDots}}</text>
      </view>
    </view>
  </view>

  <!-- è§„åˆ’ç»“æœåŒºåŸŸ -->
  <view class="plan-results" wx:if="{{hasPlans}}">
    <!-- æ ‡ç­¾é¡µ -->
    <view class="tabs">
      <view 
        class="tab {{currentTabIndex === 0 ? 'active' : ''}}" 
        bindtap="switchTab" 
        data-index="{{0}}"
      >
        ç»¼åˆæ¨è
      </view>
      <view 
        class="tab {{currentTabIndex === 1 ? 'active' : ''}}" 
        bindtap="switchTab" 
        data-index="{{1}}"
      >
        æœ€çŸ­æ’é˜Ÿ
      </view>
      <view 
        class="tab {{currentTabIndex === 2 ? 'active' : ''}}" 
        bindtap="switchTab" 
        data-index="{{2}}"
      >
        æœ€æ—©ç¦»å›­
      </view>
    </view>

    <!-- è§„åˆ’åˆ—è¡¨ -->
    <view class="plan-list">
      <!-- ç»¼åˆæ¨èè§„åˆ’ -->
      <block wx:if="{{currentTabIndex === 0}}">
        <view class="plan-item" wx:for="{{plansData.comprehensive}}" wx:key="id">
          <view class="plan-header">
            <view class="plan-title-section">
              <text class="plan-title">è§„åˆ’ {{index + 1}}</text>
              <text class="queue-savings-tip" wx:if="{{item.queueTimeSavingsTip}}">{{item.queueTimeSavingsTip}}</text>
            </view>
            <view class="plan-actions">
              <button class="favorite-btn {{item.isFavorited ? 'favorited' : ''}}" 
                      bindtap="togglePlanFavorite" 
                      data-plan-type="comprehensive" 
                      data-index="{{index}}">
                <text class="favorite-icon">{{item.isFavorited ? 'â˜…' : 'â˜†'}}</text>
                <text class="favorite-text">{{item.isFavorited ? 'å·²æ”¶è—' : 'æ”¶è—'}}</text>
              </button>
            </view>
          </view>
          
          <view class="plan-summary">
            <text class="summary-item">æ€»æ’é˜Ÿæ—¶é—´: {{item.totalWaitTime}}åˆ†é’Ÿ</text>
            <text class="summary-item">ç¦»å›­æ—¶é—´: {{item.departureTime || 'æœªçŸ¥'}}</text>
          </view>
          
          <view class="timeline">
            <view class="timeline-item" wx:for="{{item.items}}" wx:key="id" wx:for-item="subItem" wx:for-index="itemIndex">
              <view class="timeline-dot"></view>
              <view class="timeline-line" wx:if="{{itemIndex !== item.items.length - 1}}"></view>
              <view class="timeline-content">
                <view class="time-slot">
                  <text class="time">{{subItem.startTime}} - {{subItem.endTime}}</text>
                  <text class="duration">({{subItem.queueTime}}åˆ†é’Ÿ)</text>
                </view>
                <view class="project-card">
                  <image class="project-image" src="{{subItem.imageUrl || '/images/placeholder.png'}}" mode="aspectFill" binderror="onProjectImageError" data-index="{{index}}" data-item-index="{{itemIndex}}"></image>
                  <view class="project-info">
                    <view class="project-name">{{subItem.name}}</view>
                    <view class="project-detail">
                      <text class="queue-time">æ’é˜Ÿ: {{subItem.queueTime}}åˆ†é’Ÿ</text>
                      <text class="rest-time" wx:if="{{subItem.restTime}}">ä¼‘æ¯: {{subItem.restTime}}åˆ†é’Ÿ</text>
                    </view>
                  </view>
                </view>
              </view>
            </view>
          </view>
        </view>
      </block>

      <!-- æœ€çŸ­ç­‰å¾…è§„åˆ’ -->
      <block wx:elif="{{currentTabIndex === 1}}">
        <view class="plan-item" wx:for="{{plansData.shortest_wait_time}}" wx:key="id">
          <view class="plan-header">
            <view class="plan-title-section">
              <text class="plan-title">è§„åˆ’ {{index + 1}}</text>
              <text class="queue-savings-tip" wx:if="{{item.queueTimeSavingsTip}}">{{item.queueTimeSavingsTip}}</text>
            </view>
            <view class="plan-actions">
              <button class="favorite-btn {{item.isFavorited ? 'favorited' : ''}}" 
                      bindtap="togglePlanFavorite" 
                      data-plan-type="shortest_wait_time" 
                      data-index="{{index}}">
                <text class="favorite-icon">{{item.isFavorited ? 'â˜…' : 'â˜†'}}</text>
                <text class="favorite-text">{{item.isFavorited ? 'å·²æ”¶è—' : 'æ”¶è—'}}</text>
              </button>
            </view>
          </view>
          
          <view class="plan-summary">
            <text class="summary-item">æ€»æ’é˜Ÿæ—¶é—´: {{item.totalWaitTime}}åˆ†é’Ÿ</text>
            <text class="summary-item">ç¦»å›­æ—¶é—´: {{item.departureTime || 'æœªçŸ¥'}}</text>
          </view>
          
          <view class="timeline">
            <view class="timeline-item" wx:for="{{item.items}}" wx:key="id" wx:for-item="subItem" wx:for-index="itemIndex">
              <view class="timeline-dot"></view>
              <view class="timeline-line" wx:if="{{itemIndex !== item.items.length - 1}}"></view>
              <view class="timeline-content">
                <view class="time-slot">
                  <text class="time">{{subItem.startTime}} - {{subItem.endTime}}</text>
                  <text class="duration">({{subItem.queueTime}}åˆ†é’Ÿ)</text>
                </view>
                <view class="project-card">
                  <image class="project-image" src="{{subItem.imageUrl || '/images/placeholder.png'}}" mode="aspectFill" binderror="onProjectImageError" data-index="{{index}}" data-item-index="{{itemIndex}}"></image>
                  <view class="project-info">
                    <view class="project-name">{{subItem.name}}</view>
                    <view class="project-detail">
                      <text class="queue-time">æ’é˜Ÿ: {{subItem.queueTime}}åˆ†é’Ÿ</text>
                      <text class="rest-time" wx:if="{{subItem.restTime}}">ä¼‘æ¯: {{subItem.restTime}}åˆ†é’Ÿ</text>
                    </view>
                  </view>
                </view>
              </view>
            </view>
          </view>
        </view>
      </block>

      <!-- æœ€æ—©ç»“æŸè§„åˆ’ -->
      <block wx:else>
        <view class="plan-item" wx:for="{{plansData.earliest_departure}}" wx:key="id">
          <view class="plan-header">
            <view class="plan-title-section">
              <text class="plan-title">è§„åˆ’ {{index + 1}}</text>
              <text class="queue-savings-tip" wx:if="{{item.queueTimeSavingsTip}}">{{item.queueTimeSavingsTip}}</text>
            </view>
            <view class="plan-actions">
              <button class="favorite-btn {{item.isFavorited ? 'favorited' : ''}}" 
                      bindtap="togglePlanFavorite" 
                      data-plan-type="earliest_departure" 
                      data-index="{{index}}">
                <text class="favorite-icon">{{item.isFavorited ? 'â˜…' : 'â˜†'}}</text>
                <text class="favorite-text">{{item.isFavorited ? 'å·²æ”¶è—' : 'æ”¶è—'}}</text>
              </button>
            </view>
          </view>
          
          <view class="plan-summary">
            <text class="summary-item">æ€»æ’é˜Ÿæ—¶é—´: {{item.totalWaitTime}}åˆ†é’Ÿ</text>
            <text class="summary-item">ç¦»å›­æ—¶é—´: {{item.departureTime || 'æœªçŸ¥'}}</text>
          </view>
          
          <view class="timeline">
            <view class="timeline-item" wx:for="{{item.items}}" wx:key="id" wx:for-item="subItem" wx:for-index="itemIndex">
              <view class="timeline-dot"></view>
              <view class="timeline-line" wx:if="{{itemIndex !== item.items.length - 1}}"></view>
              <view class="timeline-content">
                <view class="time-slot">
                  <text class="time">{{subItem.startTime}} - {{subItem.endTime}}</text>
                  <text class="duration">({{subItem.queueTime}}åˆ†é’Ÿ)</text>
                </view>
                <view class="project-card">
                  <image class="project-image" src="{{subItem.imageUrl || '/images/placeholder.png'}}" mode="aspectFill" binderror="onProjectImageError" data-index="{{index}}" data-item-index="{{itemIndex}}"></image>
                  <view class="project-info">
                    <view class="project-name">{{subItem.name}}</view>
                    <view class="project-detail">
                      <text class="queue-time">æ’é˜Ÿ: {{subItem.queueTime}}åˆ†é’Ÿ</text>
                      <text class="rest-time" wx:if="{{subItem.restTime}}">ä¼‘æ¯: {{subItem.restTime}}åˆ†é’Ÿ</text>
                    </view>
                  </view>
                </view>
              </view>
            </view>
          </view>
        </view>
      </block>
    </view>
  </view>
</view> 